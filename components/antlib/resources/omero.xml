<?xml version="1.0" encoding="utf-8"?>
<project name="omero" default="usage" basedir="."  xmlns:ivy="antlib:org.apache.ivy.ant">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# $Id$
# 
# Copyright 2006 University of Dundee. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
# 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore <josh.moore@gmx.de>
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
  DOCUMENTATION:
  ==============================================================================
  This is the main build script for binary distributions and replaces the 
  main build script (OMERO_HOME/build.xml) in the OMERO_HOME/dist directories. 

-->

	<!-- This overrides the classpath.file properties of all the components. -->
	<property name="import.dir"       value="${basedir}/components/antlib/resources/"/>
	<property name="ivy.dep.file"  value="${basedir}/omero.ivy"/>
	<property name="ivy.buildlist.ivyfilepath"  value="${basedir}/omero.ivy"/>
	<import file="${import.dir}/global.xml"/>
	<import file="${import.dir}/dependencies.xml"/>
	<import file="${import.dir}/multiproject.xml"/>
	<import file="${import.dir}/setup.xml"/>
	<property file="${basedir}/etc/omero.properties"/>

	<target name="usage"
		description="Usage information">
		<concat>
			<filelist dir="${import.dir}" files="usage-omero.txt"/>
		</concat>
	</target>

	<target name="update">
		<fail>etc/local.properties does not exist. Try calling "setup"<condition>
		<not><available file="${basedir}/etc/local.properties"/></not></condition></fail>

                <!-- copied from app/build.xml refactor -->
      <tempfile property="temp.dir" prefix="omero"/>
      <mkdir dir="${temp.dir}"/>
      <copy file="${etc.dir}/omero-ds.xml" todir="${temp.dir}" />
      <replace file="${temp.dir}/omero-ds.xml">
         <replacefilter token="@@@JDBC.URL@@@" value="${hibernate.connection.url}"/>
         <replacefilter token="@@@JDBC.DRIVER@@@" value="${hibernate.connection.driver_class}"/>
         <replacefilter token="@@@JDBC.USERNAME@@@" value="${hibernate.connection.username}"/>
         <replacefilter token="@@@JDBC.PASSWORD@@@" value="${hibernate.connection.password}"/>
      </replace>

		<jar update="true"
		  destfile="${product.final.name}">
			<fileset dir="${basedir}/etc">
				<include name="local.properties"/>
				<include name="local.properties.example"/>
				<include name="omero.properties"/>
				<include name="hibernate.properties"/>
			</fileset>
			<fileset dir="${temp.dir}">
				<include name="omero-ds.xml"/>
			</fileset>
		</jar>
		<delete dir="${temp.dir}"/>

		<jar update="true" 
		  destfile="blitz/blitz.jar">
			<fileset dir="${basedir}/etc">
				<include name="local.properties"/>
				<include name="local.properties.example"/>
				<include name="omero.properties"/>
				<include name="hibernate.properties"/>
			</fileset>
		</jar>

	</target>

	<target name="setup-db">
		<iterate buildpathref="server.buildpath" target="reload-db"/>
	</target>

	<target name="earfiles">
		<fileset dir="${omero.home}" includes="*.ear" id="ear.files"/>
	</target>

	<target name="deploy" depends="update">
		<property name="jboss.deploy.dir" value="${env.JBOSS_HOME}/server/default/deploy"/>
		<property name="jboss.deploy.dir" value="${env.JBOSS_HOME}/server/default/deploy"/>
		<copy todir="${jboss.deploy.dir}">
			<fileset dir="${basedir}" includes="*.ear,*.war"/>
		</copy>
	</target>

</project>

